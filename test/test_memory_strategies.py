import sys
import os
import asyncio
from typing import List, Dict, Any
from datetime import datetime

# å°† agent ç›®å½•æ·»åŠ åˆ° Python è·¯å¾„ä¸­
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from agent.memory_strategy import create_memory_strategy, BaseMemoryStrategy
from agent.llm_provider import init_llm
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage, SystemMessage

# --- çœŸå®å¯¹è¯åœºæ™¯æ•°æ® ---

# åœºæ™¯1ï¼šæŠ€æœ¯æ”¯æŒå¯¹è¯
TECH_SUPPORT_CONVERSATION = [
    ("æˆ‘çš„ç”µè„‘æœ€è¿‘è¿è¡Œå¾ˆæ…¢ï¼Œç»å¸¸å¡é¡¿", "æˆ‘ç†è§£æ‚¨çš„å›°æ‰°ã€‚è®©æˆ‘å¸®æ‚¨è¯Šæ–­ä¸€ä¸‹ã€‚è¯·é—®æ‚¨çš„ç”µè„‘æ˜¯ä»€ä¹ˆæ“ä½œç³»ç»Ÿï¼Ÿå¤§æ¦‚ä½¿ç”¨äº†å¤šä¹…ï¼Ÿ"),
    ("æ˜¯Windows 11ï¼Œä¹°äº†å¤§æ¦‚2å¹´äº†", "Windows 11ç³»ç»Ÿ2å¹´çš„ä½¿ç”¨æ—¶é—´è¿˜ç®—æ¯”è¾ƒæ–°ã€‚è¯·é—®æ‚¨æœ€è¿‘æœ‰å®‰è£…ä»€ä¹ˆæ–°è½¯ä»¶å—ï¼Ÿæˆ–è€…æ³¨æ„åˆ°æ˜¯åœ¨è¿è¡Œç‰¹å®šç¨‹åºæ—¶ç‰¹åˆ«å¡é¡¿ï¼Ÿ"),
    ("ä¸»è¦æ˜¯æ‰“å¼€Chromeæµè§ˆå™¨çš„æ—¶å€™ï¼Œå¼€å¾ˆå¤šæ ‡ç­¾é¡µå°±å¡", "Chromeç¡®å®æ¯”è¾ƒå ç”¨å†…å­˜ã€‚æ‚¨ç”µè„‘çš„å†…å­˜æ˜¯å¤šå°‘ï¼Ÿå¯ä»¥æŒ‰Win+PauseæŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯ã€‚"),
    ("æˆ‘çœ‹äº†ä¸‹æ˜¯8GBå†…å­˜ï¼Œç°åœ¨å†…å­˜ä½¿ç”¨ç‡æ˜¾ç¤º85%", "8GBå†…å­˜å¯¹äºç°ä»£æµè§ˆå™¨å¤šæ ‡ç­¾ä½¿ç”¨ç¡®å®æœ‰äº›åƒç´§ã€‚æˆ‘å»ºè®®ï¼š1) ä½¿ç”¨Chromeçš„æ ‡ç­¾é¡µåˆ†ç»„åŠŸèƒ½ 2) å®‰è£…The Great Suspenderæ‰©å±•è‡ªåŠ¨æŒ‚èµ·ä¸æ´»è·ƒæ ‡ç­¾ 3) å®šæœŸæ¸…ç†æµè§ˆå™¨ç¼“å­˜"),
    ("å¥½çš„ï¼Œé‚£æˆ‘çš„å¼€æœºä¹Ÿå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿè¦5åˆ†é’Ÿæ‰èƒ½è¿›æ¡Œé¢", "å¼€æœº5åˆ†é’Ÿç¡®å®å¤ªæ…¢äº†ã€‚è¿™é€šå¸¸æ˜¯å¯åŠ¨é¡¹è¿‡å¤šæˆ–è€…ç¡¬ç›˜é—®é¢˜ã€‚æ‚¨çš„ç³»ç»Ÿç›˜æ˜¯å›ºæ€ç¡¬ç›˜è¿˜æ˜¯æœºæ¢°ç¡¬ç›˜ï¼Ÿ"),
    ("åº”è¯¥æ˜¯æœºæ¢°ç¡¬ç›˜ï¼Œæˆ‘æ²¡æœ‰æ¢è¿‡", "æ‰¾åˆ°é—®é¢˜äº†ï¼æœºæ¢°ç¡¬ç›˜æ˜¯ä¸»è¦ç“¶é¢ˆã€‚å‡çº§åˆ°å›ºæ€ç¡¬ç›˜å¯ä»¥æå¤§æå‡å¼€æœºé€Ÿåº¦å’Œæ•´ä½“å“åº”ã€‚ä¸€ä¸ª256GBçš„å›ºæ€ç¡¬ç›˜ä½œä¸ºç³»ç»Ÿç›˜ï¼Œæˆæœ¬ä¸é«˜ä½†æ•ˆæœæ˜¾è‘—ã€‚"),
    ("æ¢å›ºæ€ç¡¬ç›˜ä¼šä¸ä¼šå¾ˆéº»çƒ¦ï¼Ÿæˆ‘çš„æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ", "ä¸ç”¨æ‹…å¿ƒï¼Œå¯ä»¥ï¼š1) ä½¿ç”¨ç¡¬ç›˜å…‹éš†å·¥å…·ç›´æ¥å¤åˆ¶ç³»ç»Ÿ 2) æˆ–è€…ä¿ç•™åŸç¡¬ç›˜ä½œä¸ºæ•°æ®ç›˜ï¼Œåªåœ¨æ–°å›ºæ€ä¸Šè£…ç³»ç»Ÿã€‚å»ºè®®æ‰¾ä¸“ä¸šäººå‘˜å¸®åŠ©ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚"),
    ("é™¤äº†æ¢ç¡¬ä»¶ï¼Œè¿˜æœ‰å…¶ä»–ä¼˜åŒ–æ–¹æ³•å—ï¼Ÿ", "å½“ç„¶æœ‰ï¼è½¯ä»¶å±‚é¢å¯ä»¥ï¼š1) ç¦ç”¨ä¸å¿…è¦çš„å¯åŠ¨é¡¹(msconfig) 2) å…³é—­Windowsæœç´¢ç´¢å¼• 3) å®šæœŸç£ç›˜æ¸…ç†å’Œç¢ç‰‡æ•´ç† 4) å…³é—­ä¸éœ€è¦çš„è§†è§‰æ•ˆæœã€‚è¿™äº›èƒ½æ”¹å–„20-30%çš„æ€§èƒ½ã€‚"),
    ("æˆ‘åˆšæ‰çœ‹äº†å¯åŠ¨é¡¹ï¼Œæœ‰20å¤šä¸ªç¨‹åº", "20å¤šä¸ªå¯åŠ¨é¡¹å¤ªå¤šäº†ï¼å»ºè®®åªä¿ç•™æ€æ¯’è½¯ä»¶å’Œå¿…è¦çš„é©±åŠ¨ç¨‹åºã€‚å…¶ä»–åƒéŸ³ä¹æ’­æ”¾å™¨ã€ä¸‹è½½å·¥å…·ã€åŠå…¬è½¯ä»¶ç­‰éƒ½å¯ä»¥ç¦ç”¨è‡ªå¯åŠ¨ï¼Œéœ€è¦æ—¶æ‰‹åŠ¨æ‰“å¼€å³å¯ã€‚"),
    ("å¥½çš„ï¼Œæˆ‘è¯•è¯•çœ‹ã€‚å¯¹äº†ï¼Œæˆ‘çš„Cç›˜åªå‰©2GBç©ºé—´äº†ï¼Œæœ‰å½±å“å—ï¼Ÿ", "å½±å“å¾ˆå¤§ï¼Windowséœ€è¦è‡³å°‘15%çš„å‰©ä½™ç©ºé—´æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚ç©ºé—´ä¸è¶³ä¼šå¯¼è‡´ï¼š1) æ— æ³•åˆ›å»ºè™šæ‹Ÿå†…å­˜ 2) ç³»ç»Ÿæ›´æ–°å¤±è´¥ 3) ä¸´æ—¶æ–‡ä»¶æ— æ³•ç”Ÿæˆã€‚è¯·ç«‹å³æ¸…ç†ï¼"),
]

# åœºæ™¯2ï¼šäº§å“å’¨è¯¢å¯¹è¯ï¼ˆåŒ…å«ä¸Šä¸‹æ–‡ä¾èµ–ï¼‰
PRODUCT_CONSULTATION = [
    ("ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„äº‘æœåŠ¡å™¨äº§å“", "æ‚¨å¥½ï¼æˆ‘ä»¬æä¾›å¤šç§äº‘æœåŠ¡å™¨é…ç½®ã€‚è¯·é—®æ‚¨ä¸»è¦ç”¨äºä»€ä¹ˆç”¨é€”ï¼Ÿæ¯”å¦‚ç½‘ç«™æ‰˜ç®¡ã€åº”ç”¨å¼€å‘ã€è¿˜æ˜¯æ•°æ®åˆ†æï¼Ÿ"),
    ("ä¸»è¦æ˜¯æƒ³æ­å»ºä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œé¢„è®¡æ—¥è®¿é—®é‡åœ¨5ä¸‡å·¦å³", "æ—¥è®¿é—®5ä¸‡çš„ç”µå•†ç½‘ç«™ï¼Œå»ºè®®é€‰æ‹©æˆ‘ä»¬çš„æ ‡å‡†å‹S3é…ç½®ï¼š4æ ¸8Gå†…å­˜ï¼Œ100G SSDå­˜å‚¨ï¼Œ5Må¸¦å®½ã€‚è¿™ä¸ªé…ç½®å¯ä»¥ç¨³å®šæ”¯æ’‘æ‚¨çš„ä¸šåŠ¡éœ€æ±‚ã€‚"),
    ("è¿™ä¸ªé…ç½®çš„ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ", "æ ‡å‡†å‹S3çš„ä»·æ ¼æ˜¯ï¼šåŒ…å¹´2880å…ƒï¼ˆæœˆå‡240å…ƒï¼‰ï¼ŒåŒ…æœˆçš„è¯æ˜¯300å…ƒ/æœˆã€‚ç°åœ¨æœ‰ä¼˜æƒ æ´»åŠ¨ï¼Œæ–°ç”¨æˆ·é¦–å¹´å¯äº«å—7æŠ˜ï¼Œåªéœ€2016å…ƒã€‚"),
    ("å¬èµ·æ¥ä¸é”™ã€‚æ•°æ®å®‰å…¨æ–¹é¢æœ‰ä»€ä¹ˆä¿éšœå—ï¼Ÿ", "æ•°æ®å®‰å…¨æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼š1) ä¸‰å‰¯æœ¬å­˜å‚¨ï¼Œä»»ä½•ç¡¬ä»¶æ•…éšœä¸ä¼šä¸¢å¤±æ•°æ® 2) æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ï¼Œä¿ç•™7å¤© 3) DDoSé˜²æŠ¤å’ŒWebåº”ç”¨é˜²ç«å¢™ 4) SSLè¯ä¹¦å…è´¹æä¾›ã€‚"),
    ("å¦‚æœä»¥åä¸šåŠ¡å¢é•¿ï¼Œéœ€è¦å‡çº§é…ç½®éº»çƒ¦å—ï¼Ÿ", "å‡çº§éå¸¸æ–¹ä¾¿ï¼æ”¯æŒåœ¨çº¿æ— ç¼å‡çº§ï¼Œåªéœ€è¦åœ¨æ§åˆ¶å°æ“ä½œï¼Œ5åˆ†é’Ÿå†…å®Œæˆï¼ŒæœŸé—´æœåŠ¡ä¸ä¼šä¸­æ–­ã€‚è€Œä¸”åªéœ€è¦è¡¥å·®ä»·å³å¯ï¼Œéå¸¸çµæ´»ã€‚"),
    ("é‚£æŠ€æœ¯æ”¯æŒæ€ä¹ˆæ ·ï¼Ÿæˆ‘ä¸å¤ªæ‡‚æŠ€æœ¯", "åˆ«æ‹…å¿ƒï¼æˆ‘ä»¬æä¾›ï¼š1) 7Ã—24å°æ—¶åœ¨çº¿å®¢æœ 2) è¯¦ç»†çš„è§†é¢‘æ•™ç¨‹å’Œæ–‡æ¡£ 3) ä¸€é”®éƒ¨ç½²å¸¸ç”¨ç¯å¢ƒï¼ˆå¦‚WordPressã€å•†åŸç³»ç»Ÿï¼‰4) å‰3ä¸ªæœˆå…è´¹ä»£ç»´æŠ¤æœåŠ¡ã€‚"),
    ("å¬èµ·æ¥æŒºå…¨é¢çš„ã€‚å¦‚æœæˆ‘ç°åœ¨è´­ä¹°ï¼Œå¤šä¹…èƒ½ç”¨ä¸Šï¼Ÿ", "éå¸¸å¿«ï¼ä¸‹å•å5åˆ†é’Ÿå†…æœåŠ¡å™¨å°±ä¼šè‡ªåŠ¨å¼€é€šï¼Œæ‚¨ä¼šæ”¶åˆ°ç™»å½•ä¿¡æ¯ã€‚å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬çš„æŠ€æœ¯äººå‘˜å¯ä»¥å…è´¹å¸®æ‚¨å®Œæˆåˆå§‹ç¯å¢ƒé…ç½®ï¼Œ1å°æ—¶å†…å°±èƒ½å¼€å§‹ä½¿ç”¨ã€‚"),
    ("æˆ‘è¿˜æƒ³é—®ä¸‹ï¼Œè¿™ä¸ªé…ç½®èƒ½æ”¯æŒå¤šå°‘ä¸ªå¹¶å‘ç”¨æˆ·ï¼Ÿ", "æ ‡å‡†å‹S3é…ç½®åœ¨ä¼˜åŒ–è‰¯å¥½çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ”¯æŒ500-800ä¸ªå¹¶å‘ç”¨æˆ·ã€‚å¯¹äºæ—¥è®¿é—®5ä¸‡çš„ç½‘ç«™æ¥è¯´ç»°ç»°æœ‰ä½™ã€‚è€Œä¸”æˆ‘ä»¬æä¾›CDNåŠ é€ŸæœåŠ¡ï¼Œå¯ä»¥è¿›ä¸€æ­¥æå‡ç”¨æˆ·ä½“éªŒã€‚"),
    ("CDNæ˜¯é¢å¤–æ”¶è´¹çš„å—ï¼Ÿ", "åŸºç¡€CDNæœåŠ¡æ˜¯åŒ…å«çš„ï¼Œæ¯æœˆæœ‰100GBå…è´¹æµé‡ã€‚è¶…å‡ºéƒ¨åˆ†æŒ‰0.2å…ƒ/GBè®¡è´¹ã€‚ä¸€èˆ¬ç”µå•†ç½‘ç«™é…åˆå›¾ç‰‡ä¼˜åŒ–ï¼Œ100GBå¯ä»¥æ”¯æ’‘15-20ä¸‡PVï¼Œå®Œå…¨å¤Ÿç”¨ã€‚"),
    ("æ˜ç™½äº†ã€‚ä½ ä»¬æ”¯æŒä»€ä¹ˆä»˜æ¬¾æ–¹å¼ï¼Ÿå¯ä»¥å¼€å‘ç¥¨å—ï¼Ÿ", "æ”¯æŒæ”¯ä»˜å®ã€å¾®ä¿¡ã€é“¶è¡Œè½¬è´¦ç­‰å¤šç§æ–¹å¼ã€‚å¯ä»¥å¼€å…·å¢å€¼ç¨æ™®é€šå‘ç¥¨æˆ–ä¸“ç”¨å‘ç¥¨ï¼Œç”µå­å‘ç¥¨å®æ—¶å¼€å…·ï¼Œçº¸è´¨å‘ç¥¨2-3ä¸ªå·¥ä½œæ—¥å¯„å‡ºã€‚"),
    ("æˆ‘å›å¤´å’Œåˆä¼™äººå•†é‡ä¸€ä¸‹ã€‚å¯¹äº†ï¼Œåˆšæ‰è¯´çš„S3é…ç½®å…·ä½“æ˜¯ä»€ä¹ˆå‚æ•°ï¼Ÿ", "S3é…ç½®çš„è¯¦ç»†å‚æ•°æ˜¯ï¼šCPU 4æ ¸ï¼ˆIntel Xeon Goldï¼‰ï¼Œå†…å­˜8GB DDR4ï¼Œç³»ç»Ÿç›˜100GB SSDï¼Œå¸¦å®½5Mbpsï¼ˆBGPå¤šçº¿ï¼‰ï¼Œå…è´¹æä¾›1ä¸ªç‹¬ç«‹IPã€‚è¿™æ˜¯æˆ‘ä»¬æœ€å—æ¬¢è¿çš„é…ç½®ã€‚"),
    ("å¦‚æœæˆ‘æƒ³å…ˆè¯•ç”¨ä¸€ä¸‹å¯ä»¥å—ï¼Ÿ", "å½“ç„¶å¯ä»¥ï¼æˆ‘ä»¬æä¾›7å¤©å…è´¹è¯•ç”¨ï¼ŒåŠŸèƒ½ä¸æ­£å¼ç‰ˆå®Œå…¨ç›¸åŒã€‚è¯•ç”¨æœŸé—´çš„æ•°æ®å¯ä»¥æ— ç¼è½¬å…¥æ­£å¼æœåŠ¡ã€‚éœ€è¦æˆ‘ç°åœ¨å¸®æ‚¨å¼€é€šè¯•ç”¨å—ï¼Ÿ"),
]

# åœºæ™¯3ï¼šå­¦ä¹ è¾…å¯¼å¯¹è¯ï¼ˆéœ€è¦è®°ä½å­¦ç”Ÿç‰¹ç‚¹ï¼‰
TUTORING_CONVERSATION = [
    ("è€å¸ˆï¼Œæˆ‘æ˜¯å°æ˜ï¼Œé«˜äºŒå­¦ç”Ÿï¼Œæ•°å­¦æ€»æ˜¯å­¦ä¸å¥½", "ä½ å¥½å°æ˜ï¼é«˜äºŒæ•°å­¦ç¡®å®æœ‰ä¸€å®šéš¾åº¦ã€‚èƒ½å‘Šè¯‰æˆ‘å…·ä½“æ˜¯å“ªä¸ªéƒ¨åˆ†æ¯”è¾ƒå›°éš¾å—ï¼Ÿæ˜¯å‡½æ•°ã€æ•°åˆ—ã€è¿˜æ˜¯ç«‹ä½“å‡ ä½•ï¼Ÿ"),
    ("ä¸»è¦æ˜¯å‡½æ•°éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯ä¸‰è§’å‡½æ•°ï¼Œå®Œå…¨æä¸æ‡‚", "ä¸‰è§’å‡½æ•°ç¡®å®æ˜¯é«˜äºŒçš„éš¾ç‚¹ã€‚æˆ‘ä»¬ä»åŸºç¡€å¼€å§‹ï¼Œä½ çŸ¥é“æ­£å¼¦ã€ä½™å¼¦ã€æ­£åˆ‡çš„å®šä¹‰å—ï¼Ÿæ¯”å¦‚åœ¨ç›´è§’ä¸‰è§’å½¢ä¸­å®ƒä»¬åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆï¼Ÿ"),
    ("çŸ¥é“å®šä¹‰ï¼Œå°±æ˜¯sin=å¯¹è¾¹/æ–œè¾¹è¿™äº›ï¼Œä½†æ˜¯ä¸€åˆ°åšé¢˜å°±è’™äº†", "ç†è§£å®šä¹‰æ˜¯å¥½çš„å¼€å§‹ï¼é—®é¢˜å¯èƒ½åœ¨äºç¼ºä¹å½¢è±¡ç†è§£ã€‚æˆ‘å»ºè®®ä½ æŠŠä¸‰è§’å‡½æ•°æƒ³è±¡æˆåœ†ä¸Šçš„åæ ‡ã€‚å•ä½åœ†ä¸Šçš„ç‚¹(x,y)ï¼Œxå°±æ˜¯cosï¼Œyå°±æ˜¯sinã€‚è¿™æ ·ç†è§£ä¼šç›´è§‚å¾ˆå¤šã€‚"),
    ("å“¦ï¼Œè¿™æ ·å•Šã€‚ä½†æ˜¯é‚£äº›è¯±å¯¼å…¬å¼å¤ªå¤šäº†ï¼Œæ ¹æœ¬è®°ä¸ä½", "ä¸è¦æ­»è®°ç¡¬èƒŒï¼è¯±å¯¼å…¬å¼éƒ½æœ‰è§„å¾‹ï¼š'å¥‡å˜å¶ä¸å˜ï¼Œç¬¦å·çœ‹è±¡é™'ã€‚æ¯”å¦‚sin(Ï€/2+Î±)ï¼ŒÏ€/2æ˜¯90åº¦ï¼Œæ˜¯Ï€/2çš„å¥‡æ•°å€ï¼Œæ‰€ä»¥sinå˜cosï¼Œç¬¬äºŒè±¡é™sinä¸ºæ­£ï¼Œæ‰€ä»¥ç»“æœæ˜¯cosÎ±ã€‚"),
    ("è¿™ä¸ªå£è¯€æˆ‘å¬è¿‡ï¼Œä½†è¿˜æ˜¯ä¸å¤ªä¼šç”¨", "æˆ‘ä»¬æ¥ç»ƒä¹ ä¸€ä¸ªï¼šcos(Ï€-Î±)ç­‰äºä»€ä¹ˆï¼Ÿé¦–å…ˆï¼ŒÏ€æ˜¯180åº¦ï¼Œæ˜¯Ï€/2çš„å¶æ•°å€ï¼Œæ‰€ä»¥cosä¸å˜è¿˜æ˜¯cosï¼›å…¶æ¬¡ï¼ŒÏ€-Î±åœ¨ç¬¬äºŒè±¡é™ï¼Œcosä¸ºè´Ÿï¼Œæ‰€ä»¥ç»“æœæ˜¯-cosÎ±ã€‚ä½ è¯•è¯•sin(3Ï€/2+Î±)ï¼Ÿ"),
    ("è®©æˆ‘æƒ³æƒ³...3Ï€/2æ˜¯270åº¦ï¼Œæ˜¯Ï€/2çš„å¥‡æ•°å€ï¼Œsinè¦å˜æˆcosï¼›3Ï€/2+Î±åœ¨ç¬¬å››è±¡é™ï¼Œsinä¸ºè´Ÿï¼Œæ‰€ä»¥æ˜¯-cosÎ±ï¼Ÿ", "å®Œå…¨æ­£ç¡®ï¼ä½ çœ‹ï¼ŒæŒæ¡æ–¹æ³•åå°±ä¸éš¾äº†ã€‚å…³é”®æ˜¯ç†è§£åŸç†è€Œä¸æ˜¯æ­»è®°ã€‚æˆ‘ä»¬å†ç»ƒå‡ ä¸ªå·©å›ºä¸€ä¸‹ã€‚"),
    ("è€å¸ˆï¼Œæˆ‘æœˆè€ƒå°±è¦åˆ°äº†ï¼Œé™¤äº†ä¸‰è§’å‡½æ•°è¿˜æœ‰å‡½æ•°å›¾åƒå˜æ¢ä¹Ÿä¸ä¼š", "å‡½æ•°å›¾åƒå˜æ¢å…¶å®å°±æ˜¯'å¹³ç§»'å’Œ'ä¼¸ç¼©'ã€‚è®°ä½å£è¯€ï¼š'å·¦åŠ å³å‡ï¼Œä¸ŠåŠ ä¸‹å‡'ã€‚y=f(x-2)+3å°±æ˜¯æŠŠåŸå›¾åƒå³ç§»2å•ä½ï¼Œä¸Šç§»3å•ä½ã€‚"),
    ("é‚£y=2sin(2x+Ï€/3)è¿™ç§æ€ä¹ˆå˜æ¢ï¼Ÿ", "è¿™æ¶‰åŠå¤šä¸ªå˜æ¢ï¼š1)2xä½¿å‘¨æœŸå˜ä¸ºåŸæ¥çš„1/2ï¼ˆæ¨ªå‘å‹ç¼©ï¼‰2)+Ï€/3ä½¿å›¾åƒå·¦ç§»Ï€/6ï¼ˆæ³¨æ„è¦é™¤ä»¥xçš„ç³»æ•°2ï¼‰3)å‰é¢çš„2ä½¿æŒ¯å¹…å˜ä¸º2å€ï¼ˆçºµå‘æ‹‰ä¼¸ï¼‰ã€‚é¡ºåºå¾ˆé‡è¦ï¼"),
    ("å¤ªå¤æ‚äº†...æœ‰æ²¡æœ‰ç®€å•çš„è®°å¿†æ–¹æ³•ï¼Ÿ", "æœ‰ï¼æŒ‰ç…§'å…ˆç›¸ä½åå‘¨æœŸå†æŒ¯å¹…'çš„é¡ºåºï¼š1)çœ‹xçš„æ•´ä½“ï¼ˆ2x+Ï€/3ï¼‰ï¼Œå·¦ç§»Ï€/6ï¼›2)çœ‹xçš„ç³»æ•°2ï¼Œæ¨ªå‘å‹ç¼©1/2ï¼›3)çœ‹å‡½æ•°å‰çš„ç³»æ•°2ï¼Œçºµå‘æ‹‰ä¼¸2å€ã€‚ç”»å›¾æ—¶æŒ‰è¿™ä¸ªé¡ºåºå°±ä¸ä¼šä¹±ã€‚"),
    ("æ˜ç™½äº†ä¸€äº›ã€‚è€å¸ˆï¼Œæˆ‘åŸºç¡€æ¯”è¾ƒå·®ï¼Œæ˜¯ä¸æ˜¯åº”è¯¥å¤šåˆ·é¢˜ï¼Ÿ", "åˆ·é¢˜è¦æœ‰æ–¹æ³•ï¼å»ºè®®ï¼š1)å…ˆåšè¯¾æœ¬ä¾‹é¢˜ï¼Œå®Œå…¨ç†è§£ 2)åˆ†ä¸“é¢˜ç»ƒä¹ ï¼Œæ¯”å¦‚è¿™å‘¨åªç»ƒä¸‰è§’å‡½æ•° 3)é”™é¢˜è¦æ•´ç†åˆ†æï¼Œæ‰¾å‡ºæ€ç»´ç›²ç‚¹ 4)æ¯å¤©30åˆ†é’Ÿï¼ŒåšæŒæ¯”çªå‡»æœ‰æ•ˆã€‚è®°ä½ä½ æ˜¯å°æ˜ï¼ŒåŸºç¡€éœ€è¦æ…¢æ…¢è¡¥ã€‚"),
    ("æˆ‘å¦ˆæ€»è¯´æˆ‘ç¬¨ï¼Œå­¦ä¸å¥½æ•°å­¦", "ä¸è¦è¿™æ ·æƒ³ï¼æ¯ä¸ªäººçš„å­¦ä¹ èŠ‚å¥ä¸åŒã€‚ä½ åˆšæ‰èƒ½æ­£ç¡®æ¨å¯¼sin(3Ï€/2+Î±)ï¼Œè¯´æ˜ä½ å®Œå…¨æœ‰èƒ½åŠ›å­¦å¥½ã€‚æ•°å­¦éœ€è¦çš„æ˜¯æ­£ç¡®çš„æ–¹æ³•å’ŒåšæŒç»ƒä¹ ï¼Œä¸æ˜¯å¤©èµ‹ã€‚ç›¸ä¿¡è‡ªå·±ï¼"),
    ("è°¢è°¢è€å¸ˆçš„é¼“åŠ±ã€‚æˆ‘æƒ³é—®ä¸‹ï¼Œä¸‹æ¬¡æœˆè€ƒé‡ç‚¹ä¼šè€ƒä»€ä¹ˆï¼Ÿ", "æ ¹æ®é«˜äºŒè¿›åº¦ï¼Œæœˆè€ƒé‡ç‚¹é€šå¸¸æ˜¯ï¼š1)ä¸‰è§’å‡½æ•°çš„å›¾åƒå’Œæ€§è´¨ 2)ä¸‰è§’æ’ç­‰å˜æ¢ 3)è§£ä¸‰è§’å½¢ï¼ˆæ­£å¼¦å®šç†ã€ä½™å¼¦å®šç†ï¼‰ã€‚ä½ ç°åœ¨è¦é‡ç‚¹çªç ´ä¸‰è§’å‡½æ•°åŸºç¡€ï¼Œè¿™æ˜¯å…¶ä»–å†…å®¹çš„åŸºç¡€ã€‚"),
    ("å¥½çš„ï¼Œæˆ‘ä¼šåŠªåŠ›çš„ã€‚å¯¹äº†è€å¸ˆï¼Œä½ ä¸Šæ¬¡è¯´çš„é‚£ä¸ªå­¦ä¹ æ–¹æ³•æ˜¯ä»€ä¹ˆæ¥ç€ï¼Ÿ", "ä½ æ˜¯æŒ‡'å…ˆç›¸ä½åå‘¨æœŸå†æŒ¯å¹…'çš„å›¾åƒå˜æ¢é¡ºåºå—ï¼Ÿè¿˜æ˜¯æŒ‡å­¦ä¹ è§„åˆ’'æ¯å¤©30åˆ†é’Ÿåˆ†ä¸“é¢˜ç»ƒä¹ 'ï¼Ÿæˆ‘åˆšæ‰ç»™ä½ è®²äº†å¥½å‡ ä¸ªæ–¹æ³•ï¼Œä½ æƒ³å¤ä¹ å“ªä¸ªï¼Ÿ"),
]

def create_conversation_messages(conversation_data: List[tuple]) -> List[BaseMessage]:
    """å°†å¯¹è¯æ•°æ®è½¬æ¢ä¸ºæ¶ˆæ¯åˆ—è¡¨"""
    messages = []
    for human, ai in conversation_data:
        messages.append(HumanMessage(content=human))
        messages.append(AIMessage(content=ai))
    return messages

def print_strategy_comparison(strategy_name: str, original_count: int, final_count: int, 
                            final_messages: List[BaseMessage], execution_time: float):
    """ç¾åŒ–æ‰“å°ç­–ç•¥å¯¹æ¯”ç»“æœ"""
    print(f"\n{'='*60}")
    print(f"ç­–ç•¥: {strategy_name}")
    print(f"æ‰§è¡Œæ—¶é—´: {execution_time:.2f}ç§’")
    print(f"åŸå§‹æ¶ˆæ¯æ•°: {original_count} â†’ æœ€ç»ˆæ¶ˆæ¯æ•°: {final_count} (ä¿ç•™ç‡: {final_count/original_count*100:.1f}%)")
    print(f"{'-'*60}")
    
    # æ‰“å°æœ€ç»ˆçš„æ¶ˆæ¯å†…å®¹
    for i, msg in enumerate(final_messages):
        msg_type = "ç³»ç»Ÿ" if isinstance(msg, SystemMessage) else "ç”¨æˆ·" if isinstance(msg, HumanMessage) else "åŠ©æ‰‹"
        content = msg.content.replace('\n', ' ')
        
        # ç‰¹æ®Šå¤„ç†æ‘˜è¦æ¶ˆæ¯
        if isinstance(msg, SystemMessage) and "ã€ç´¯ç§¯å¯¹è¯æ‘˜è¦" in msg.content:
            print(f"[{i+1}] ğŸ“ æ‘˜è¦æ¶ˆæ¯:")
            summary_content = msg.content.split('\n', 1)[1] if '\n' in msg.content else msg.content
            print(f"     {summary_content[:150]}...")
        else:
            # é™åˆ¶æ¯æ¡æ¶ˆæ¯æ˜¾ç¤ºé•¿åº¦
            display_content = content[:100] + "..." if len(content) > 100 else content
            icon = "ğŸ‘¤" if msg_type == "ç”¨æˆ·" else "ğŸ¤–" if msg_type == "åŠ©æ‰‹" else "âš™ï¸"
            print(f"[{i+1}] {icon} {msg_type}: {display_content}")

async def test_scenario(scenario_name: str, messages: List[BaseMessage], strategy_configs: Dict[str, Dict]):
    """æµ‹è¯•å•ä¸ªåœºæ™¯"""
    print(f"\n{'#'*80}")
    print(f"# {scenario_name}")
    print(f"# æ€»æ¶ˆæ¯æ•°: {len(messages)} æ¡")
    print(f"{'#'*80}")
    
    # åˆå§‹åŒ–çœŸå®çš„LLM
    llm = init_llm()
    
    # æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    system_message = SystemMessage(content="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œè¯·æ ¹æ®å¯¹è¯å†å²æä¾›å¸®åŠ©ã€‚")
    full_messages = [system_message] + messages
    
    # æµ‹è¯•æ¯ä¸ªç­–ç•¥
    for strategy_name, config in strategy_configs.items():
        try:
            # å¤åˆ¶é…ç½®ä»¥é¿å…ä¿®æ”¹åŸå§‹å­—å…¸
            config_copy = config.copy()
            
            # åˆ›å»ºç­–ç•¥å®ä¾‹
            strategy_type = config_copy.pop('type')
            if strategy_type == 'summary':
                config_copy['llm'] = llm
            
            strategy = create_memory_strategy(strategy_type, **config_copy)
            
            # æ‰§è¡Œç­–ç•¥
            start_time = datetime.now()
            hook = strategy.create_pre_model_hook()
            state = {"messages": full_messages}
            result = hook(state)
            execution_time = (datetime.now() - start_time).total_seconds()
            
            final_messages = result.get("llm_input_messages", [])
            
            # æ‰“å°ç»“æœ
            print_strategy_comparison(
                strategy_name=strategy_name,
                original_count=len(full_messages),
                final_count=len(final_messages),
                final_messages=final_messages,
                execution_time=execution_time
            )
            
        except Exception as e:
            print(f"\nâŒ ç­–ç•¥ {strategy_name} æ‰§è¡Œå¤±è´¥: {str(e)}")
            import traceback
            traceback.print_exc()

async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("ğŸš€ å¼€å§‹æµ‹è¯•ä¸åŒè®°å¿†ç­–ç•¥åœ¨çœŸå®åœºæ™¯ä¸‹çš„è¡¨ç°")
    print(f"â° æµ‹è¯•æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # å®šä¹‰è¦æµ‹è¯•çš„ç­–ç•¥é…ç½®
    strategy_configs = {
        "æ— é™åˆ¶ç­–ç•¥": {"type": "none"},
        "æ»‘åŠ¨çª—å£(10æ¡)": {"type": "sliding_window", "max_messages": 10},
        "Tokené™åˆ¶(50)": {"type": "token_limit", "max_tokens": 50},
        "è‡ªé€‚åº”ç­–ç•¥": {"type": "adaptive", "short_conversation_threshold": 10, "long_conversation_max_tokens": 200},
        "æ‘˜è¦ç­–ç•¥": {"type": "summary", "keep_recent": 4, "checkpoint_interval": 8},
    }
    
    # æµ‹è¯•åœºæ™¯1ï¼šæŠ€æœ¯æ”¯æŒï¼ˆ20è½®å¯¹è¯ï¼‰
    tech_messages = create_conversation_messages(TECH_SUPPORT_CONVERSATION)
    await test_scenario("åœºæ™¯1: æŠ€æœ¯æ”¯æŒå¯¹è¯", tech_messages, strategy_configs)
    
    # æµ‹è¯•åœºæ™¯2ï¼šäº§å“å’¨è¯¢ï¼ˆ24è½®å¯¹è¯ï¼ŒåŒ…å«å¤§é‡ç»†èŠ‚ï¼‰
    product_messages = create_conversation_messages(PRODUCT_CONSULTATION)
    await test_scenario("åœºæ™¯2: äº§å“å’¨è¯¢å¯¹è¯", product_messages, strategy_configs)
    
    # æµ‹è¯•åœºæ™¯3ï¼šå­¦ä¹ è¾…å¯¼ï¼ˆ26è½®å¯¹è¯ï¼Œéœ€è¦è®°ä½å­¦ç”Ÿç‰¹ç‚¹ï¼‰
    tutoring_messages = create_conversation_messages(TUTORING_CONVERSATION)
    await test_scenario("åœºæ™¯3: å­¦ä¹ è¾…å¯¼å¯¹è¯", tutoring_messages, strategy_configs)
    
    print("\nâœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼")
    print("\nğŸ“Š æµ‹è¯•æ€»ç»“ï¼š")
    print("- æ— é™åˆ¶ç­–ç•¥ï¼šä¿ç•™æ‰€æœ‰ä¸Šä¸‹æ–‡ï¼Œé€‚åˆçŸ­å¯¹è¯")
    print("- æ»‘åŠ¨çª—å£ï¼šç®€å•é«˜æ•ˆï¼Œä½†å¯èƒ½ä¸¢å¤±é‡è¦æ—©æœŸä¿¡æ¯")
    print("- Tokené™åˆ¶ï¼šç²¾ç¡®æ§åˆ¶æˆæœ¬ï¼Œä½†æˆªæ–­å¯èƒ½ä¸å¤Ÿæ™ºèƒ½")
    print("- è‡ªé€‚åº”ç­–ç•¥ï¼šå¹³è¡¡äº†çŸ­å¯¹è¯å’Œé•¿å¯¹è¯çš„éœ€æ±‚")
    print("- æ‘˜è¦ç­–ç•¥ï¼šæœ€é€‚åˆé•¿å¯¹è¯ï¼Œèƒ½ä¿ç•™å…³é”®ä¿¡æ¯ï¼Œä½†éœ€è¦é¢å¤–çš„LLMè°ƒç”¨")

if __name__ == "__main__":
    asyncio.run(main())
